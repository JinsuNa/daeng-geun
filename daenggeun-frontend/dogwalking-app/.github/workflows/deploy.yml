name: ë°°í¬

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest # ì‘ì—…ì´ ì‹¤í–‰ë  í™˜ê²½
    steps:
    - name: ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v3
    - name: ë„ì»¤í—ˆë¸Œì— ë¡œê·¸ì¸
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKER_USER_NAME }}
        password: ${{ secrets.DOCKER_USER_PW }}
    - name: ì´ë¯¸ì§€ ë¹Œë“œ
      run: docker build -t ${{ secrets.DOCKER_USER_NAME }}/${{ secrets.DOCKER_IMAGE_NAME }} .
    - name: ë„ì»¤í—ˆë¸Œì— ì´ë¯¸ì§€ í‘¸ì‹œ
      run: docker push ${{ secrets.DOCKER_USER_NAME }}/${{ secrets.DOCKER_IMAGE_NAME }}
    - name: AWS EC2ì— ssh ì ‘ì† í›„ ë°°í¬
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.AWS_IP }}
        port: 22
        username: ubuntu
        key: ${{ secrets.AWS_KEY }}
        script: |
          timedatectl set-timezone Asia/Seoul

          echo "âœ… ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ"
          docker-compose down --remove-orphans || true

          echo "ğŸ§¹ ê¸°ì¡´ ì´ë¯¸ì§€ì™€ ë„¤íŠ¸ì›Œí¬ ì™„ì „ ì •ë¦¬"
          docker system prune -af || true

          echo "ğŸ“¦ ì´ë¯¸ì§€ ë‹¤ì‹œ pull"
          S3_ACCESSKEY=${{ secrets.S3_ACCESSKEY }} \
          S3_SECRETKEY=${{ secrets.S3_SECRETKEY }} \
          docker-compose pull

          echo "ğŸš€ ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰"
          S3_ACCESSKEY=${{ secrets.S3_ACCESSKEY }} \
          S3_SECRETKEY=${{ secrets.S3_SECRETKEY }} \
          docker-compose up -d